package com.mingcloud.proxy.logiclayer.cheryhandler;

import com.mingcloud.proxy.datacenter.DataCenter;
import com.mingcloud.proxy.datalayer.dao.archiveinfo.UsersMapper;
import com.mingcloud.proxy.datalayer.dto.archiveinfo.UsersDto;
import com.mingcloud.proxy.datalayer.entity.archiveinfo.UsersEntity;
import com.mingcloud.proxy.util.JdbcChange;
import com.mingcloud.proxy.util.SpringContextUtil;
import org.apache.log4j.Logger;

import java.util.List;

public class CheryUserDataInThread implements Runnable{

    private static Logger logger = Logger.getLogger(CheryUserDataInThread.class);

    private JdbcChange jdbcChange = JdbcChange.getJdbcChange();

    private DataCenter dataCenter = DataCenter.getInstance();

    private UsersMapper usersMapper = SpringContextUtil.getBean("usersMapper");

    @Override
    public void run() {
        logger.info("CheryUserDataInThread begin");
        jdbcChange.changeJdbc(JdbcChange.oracleDataSource);
        while(true) {
            try {
                if(dataCenter.getUserslistSize() < DataCenter.COMMONRECORDEXLIST_MAX_LENGTH) {
                    getAllUsersData();
                }
                logger.info("CheryUserDataInThread wait for 20 minutes...");
                Thread.sleep(20 * 60 * 1000);
            } catch (Exception e) {
                logger.error("CheryUserDataInThread: " + e);
            }
        }
    }

    private void getAllUsersData() {
        List<UsersEntity> usersList = null;
        try {
            usersList = usersMapper.selectAllUsers();
            if (usersList != null && !usersList.isEmpty()) {
                for (UsersEntity entity : usersList) {
                    UsersDto dto = new UsersDto();
                    dto.setUserkey(entity.getUserkey());
                    dto.setUsername(entity.getUsername());
                    dto.setWorkSupplierKey(entity.getWorkSupplierKey());
                    dataCenter.pushUserslist(dto);
                }
                logger.info("CheryUserDataInThread getAllUsersData succeeded...");
            }
        } catch (Exception e) {
            logger.error("CheryUserDataInThread getAllUsersData: " + e);
        }
    }
}
