package com.mingcloud.proxy.logiclayer.huaweihandler;

import java.util.List;

import org.apache.log4j.Logger;

import com.mingcloud.proxy.datacenter.DataCenter;
import com.mingcloud.proxy.datalayer.dao.archiveinfo.MaintenanceobjectMapper;
import com.mingcloud.proxy.datalayer.dto.archiveinfo.MaintenanceobjectDto;
import com.mingcloud.proxy.datalayer.entity.archiveinfo.MaintenanceobjectEntity;
import com.mingcloud.proxy.util.JdbcChange;
import com.mingcloud.proxy.util.SpringContextUtil;

public class MaintenanceDataInThread implements Runnable {

	private static Logger logger = Logger.getLogger(MaintenanceDataInThread.class);
	
	private JdbcChange jdbcChange = JdbcChange.getJdbcChange();
	
	private DataCenter dataCenter = DataCenter.getInstance();
	
	private MaintenanceobjectMapper maintenanceobjectMapper = SpringContextUtil.getBean("maintenanceobjectMapper");
	
	public MaintenanceDataInThread() {
		// TODO Auto-generated constructor stub
		// 设置数据源为oracle
		jdbcChange.changeJdbc(JdbcChange.oracleDataSource);
	}
	
	@Override
	public void run() {
		// TODO Auto-generated method stub
		logger.info("MaintenanceDataInThread begin");
		
		while(true) {
			try {
				if(dataCenter.getMaintenancelistSize() < DataCenter.COMMONRECORDEXLIST_MAX_LENGTH) {
					getAllMaintenanceobjectData();
					logger.info("MaintenanceDataInThread wait for 10 minutes...");
					Thread.sleep(10 * 60 * 1000);
				} else {
					logger.info("MaintenanceDataInThread wait for 5 minutes...");
					Thread.sleep(5 * 60 * 1000);
				}
			} catch(Exception e) {
				logger.error("MaintenanceDataInThread: " + e);
			}
		}
	}

	private void getAllMaintenanceobjectData() {
		// TODO Auto-generated method stub
		List<MaintenanceobjectEntity> list = null;
		try {
			list = maintenanceobjectMapper.selectAllApi();
			if(list != null && !list.isEmpty()) {
				for(MaintenanceobjectEntity entity : list) {
					MaintenanceobjectDto dto = new MaintenanceobjectDto();
					dto.setMokey(entity.getMokey());
					dto.setMoname(entity.getMoname());
					dto.setExtravarchar1(entity.getExtravarchar1());
					dto.setExtravarchar2(entity.getExtravarchar2());
					dto.setExtravarchar3(entity.getExtravarchar3());
					dto.setExtramoinfo1(entity.getExtramoinfo1());
					dto.setExtramoinfo2(entity.getExtramoinfo2());
					dto.setExtramoinfo3(entity.getExtramoinfo3());
					dto.setExtramoinfo4(entity.getExtramoinfo4());
					dto.setGuarantyexpiredate(entity.getGuarantyexpiredate());
					dto.setDeliverydate(entity.getDeliverydate());
					dto.setAccountid(entity.getAccountid());
					dataCenter.pushMaintenancelist(dto);
				}
				logger.info("MaintenanceDataInThread getAllMaintenanceobjectData succeeded...");
			}
		} catch(Exception e) {
			logger.error("MaintenanceDataInThread getAllMaintenanceobjectData: " + e);
		}
	}
}
