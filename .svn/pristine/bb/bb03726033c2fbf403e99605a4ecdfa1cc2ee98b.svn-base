package com.mingcloud.proxy.logiclayer.vcomhandler;

import com.mingcloud.proxy.datacenter.DataCenter;
import com.mingcloud.proxy.datalayer.dao.archiveinfo.CommonrecodeMapper;
import com.mingcloud.proxy.datalayer.dao.archiveinfo.CommonrecodeexMapper;
import com.mingcloud.proxy.datalayer.dto.archiveinfo.CommonrecodeexDto;
import com.mingcloud.proxy.datalayer.entity.archiveinfo.CommonrecodeexEntity;
import com.mingcloud.proxy.util.SpringContextUtil;
import org.apache.log4j.Logger;
import org.springframework.transaction.annotation.Transactional;

import java.math.BigDecimal;
import java.util.Date;
import java.util.List;

public class VComDataOutThread implements Runnable {
	private static Logger logger = Logger.getLogger(VComDataOutThread.class);

	private CommonrecodeexMapper commonrecodeexMapper = 
			SpringContextUtil.getBean("commonrecodeexMapper");
	private CommonrecodeMapper commonrecodeMapper =
			SpringContextUtil.getBean("commonrecodeMapper");
	
	private DataCenter dataCenter = DataCenter.getInstance();
	
	public void run() {
		while (true) {
			if (dataCenter.getCommonrecodeexlistSize() > 0) {
				logger.info("VcomDataCenter size: " +dataCenter.getCommonrecodeexlistSize());
				InsertCommonrecodeex();
			}
			try {
				Thread.sleep(50);
			} catch (InterruptedException e) {
				logger.error("VComDayDataOutThread: " + e);
			}
		}
	}
	
	@Transactional
	private void InsertCommonrecodeex() {
		try {
			CommonrecodeexDto dto = dataCenter.popCommonrecodeexlist();

			CommonrecodeexEntity commonrecodeexentity = new CommonrecodeexEntity();
			commonrecodeexentity.setExtraid1(dto.getExtraid1());
			commonrecodeexentity.setExtradatetime1(dto.getExtradatetime1());
			commonrecodeexentity.setNtype(dto.getNtype());
			commonrecodeexentity.setExtravarchar1(dto.getExtravarchar1());
			commonrecodeexentity.setOrgid(dto.getOrgid());
			List<CommonrecodeexEntity> list = commonrecodeexMapper.select(commonrecodeexentity);
			// value
			commonrecodeexentity.setExtradecimal1(dto.getExtradecimal1());
			commonrecodeexentity.setExtravarchar2(dto.getExtravarchar2());
			
			int type = dto.getNtype();
			
			if (list.size() > 0 && (type == 10 || type == 1 || type == 2 || type == 3 ||
					type == 4 || type == 8 || type == 9 || type == 10 || type == 13)) {
				for (int i = 0; i < list.size(); i++) {
					Integer id = list.get(i).getId();
					commonrecodeexentity.setId(id);
					commonrecodeexentity.setModificationdate(new Date());
					if(commonrecodeexentity.getNtype()==13&&commonrecodeexentity.getExtradecimal1()==null){
						commonrecodeexentity.setExtradecimal1(new BigDecimal(25));
					}
					// 更新
					commonrecodeexMapper.update(commonrecodeexentity);
					logger.info("Updating Vcom data succeeded...");
				}
			}
			if (list.size() == 0 ) {
				// 新增
				commonrecodeexentity.setCreatedate(new Date());
				if(commonrecodeexentity.getNtype().equals(13)&&commonrecodeexentity.getExtradecimal1()==null){
					commonrecodeexentity.setExtradecimal1(new BigDecimal(25));
				}
				if(!commonrecodeexentity.getNtype().equals(30)) {
					commonrecodeexMapper.insert(commonrecodeexentity);
				}
				logger.info("Inserting Vcom data succeeded...");
			}

		} catch (Exception e) {
			logger.error("VComDayDataOutThread.InsertCommonrecodeex: " + e);
		}
	}
}
