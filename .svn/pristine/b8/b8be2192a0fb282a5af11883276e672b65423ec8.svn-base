package com.mingcloud.proxy.logiclayer.meshandler;

import com.mingcloud.proxy.datacenter.DataCenter;
import com.mingcloud.proxy.datalayer.dao.archiveinfo.MesRecordMapper;
import com.mingcloud.proxy.datalayer.dto.archiveinfo.MesRecordDto;
import com.mingcloud.proxy.util.JdbcChange;
import com.mingcloud.proxy.util.SpringContextUtil;
import org.apache.log4j.Logger;

import java.util.Date;
import java.util.List;


public class MesDataInThread implements Runnable{

    private static Logger logger = Logger.getLogger(MesDataInThread.class);

    private JdbcChange jdbcChange = JdbcChange.getJdbcChange();

    private DataCenter dataCenter = DataCenter.getInstance();

    private MesRecordMapper mesRecordMapper = SpringContextUtil.getBean("mesRecordMapper");

    /**
     * 最后一次查询时间
     */
    private static Date lastSelectDate;

    @Override
    public void run() {
        logger.info("MesDataInThread begin ...");
        // 设置数据源为oracle
        jdbcChange.changeJdbc(JdbcChange.oracleDataSource);
        logger.info("MesDataInThread change to oracleDataSource");
        while (true) {
            try {
                if (dataCenter.getMesRecordListSize() < dataCenter.COMMONRECORDEXLIST_MAX_LENGTH) {
                    getAllMesData();
                    logger.info("MesDataInThread wait for 1 minutes...");
                    Thread.sleep(24 * 60 * 60 * 1000);
                } else {
                    logger.info("MesDataInThread wait for 5 minutes...");
                    Thread.sleep(5 * 60 * 1000);
                }
            } catch (Exception e) {
                logger.error("MesDataInThread: " + e);
            }

        }

    }

    private void getAllMesData(){
        List<MesRecordDto> list = null;
        try {
            list = mesRecordMapper.selectAllApi();
            if (null != list && list.size() > 0) {
                for (MesRecordDto dto : list) {
                    dataCenter.pushMesRecordList(dto);
                }
            }
            logger.info("MesRecordSize========================" + dataCenter.getMesRecordListSize());
        } catch (Exception e) {
            logger.error("MesDataInThread getAllMesData :" + e);
        }
    }
}
