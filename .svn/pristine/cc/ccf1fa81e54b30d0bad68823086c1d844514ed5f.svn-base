<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >

<mapper namespace="com.mingcloud.proxy.datalayer.dao.archiveinfo.MessageSourceMapper">


    <resultMap id="BaseResultMap" type="MessageSourceEntity">
        <result column="messagesourcekey" property="messagesourcekey" jdbcType="VARCHAR"/>
        <result column="messagesourcename" property="messagesourcename" jdbcType="VARCHAR"/>
        <result column="querysql" property="querysql" jdbcType="VARCHAR"/>
        <result column="content" property="content" jdbcType="VARCHAR"/>
        <result column="keyword" property="keyword" jdbcType="VARCHAR"/>
        <result column="type" property="type" jdbcType="INTEGER"/>
        <result column="emailtitle" property="emailtitle" jdbcType="VARCHAR"/>
        <result column="acceptor" property="acceptor" jdbcType="VARCHAR"/>
        <result column="messageswitch" property="messageswitch" jdbcType="INTEGER"/>
        <result column="messageinterval" property="messageinterval" jdbcType="INTEGER"/>
        <result column="lastexecutedate" property="lastexecutedate" jdbcType="TIMESTAMP"/>
        <result column="nextexecutedate" property="nextexecutedate" jdbcType="TIMESTAMP"/>
        <result column="tombstone" property="tombstone" jdbcType="INTEGER"/>
        <result column="messagedatenum" property="messagedatenum" jdbcType="INTEGER"/>
        <result column="messagedatetype" property="messagedatetype" jdbcType="INTEGER"/>
    </resultMap>

    <sql id="table_name">
      messagesource
  </sql>

    <sql id="Base_Column_List">
        <include refid="table_name"/>.id,
        <include refid="table_name"/>.messagesourcekey,
        <include refid="table_name"/>.messagesourcename,
        <include refid="table_name"/>.querysql,
        <include refid="table_name"/>.content,
        <include refid="table_name"/>.keyword,
        <include refid="table_name"/>.type,
        <include refid="table_name"/>.emailtitle,
        <include refid="table_name"/>.acceptor,
        <include refid="table_name"/>.messageswitch,
        <include refid="table_name"/>.messageinterval,
        <include refid="table_name"/>.lastexecutedate,
        <include refid="table_name"/>.nextexecutedate,
        <include refid="table_name"/>.tombstone
    </sql>


    <select id="selectAll" resultMap="BaseResultMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM
        <include refid="table_name"/>
        WHERE
        <include refid="table_name"/>.messageswitch=1
        <!--AND <include refid="table_name"/>.type=3-->
        AND <include refid="table_name"/>.tombstone=1
    </select>

    <update id="updateBatchMessageSourceInterval" parameterType="java.util.List">
        UPDATE <include refid="table_name"/>
        <trim prefix="set" suffixOverrides=",">
            <trim prefix="lastexecutedate =case" suffix="end,">
                <foreach collection="list" item="item" index="index">
                    <if test="item.lastexecutedate!=null">
                        WHEN id=#{item.id} THEN #{item.lastexecutedate}
                    </if>
                </foreach>
            </trim>
            <trim prefix=" nextexecutedate =case" suffix="end,">
                <foreach collection="list" item="item" index="index">
                    <if test="item.nextexecutedate!=null">
                        WHEN id=#{item.id} THEN #{item.nextexecutedate}
                    </if>
                </foreach>
            </trim>
        </trim>
        WHERE
        <include refid="table_name"/>.tombstone = 1
        AND
        <foreach collection="list" separator="or" item="item" index="index" >
            id=#{item.id}
        </foreach>
    </update>

</mapper>