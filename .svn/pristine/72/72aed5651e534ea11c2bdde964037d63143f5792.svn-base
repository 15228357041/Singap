package com.mingcloud.proxy.logiclayer.beiqidisposeouthandler;

import com.mingcloud.proxy.datacenter.DataCenter;
import com.mingcloud.proxy.datacenter.SIFATransferData;
import com.mingcloud.proxy.datalayer.dto.archiveinfo.CommonrecodeexDto;
import com.mingcloud.proxy.datalayer.entity.archiveinfo.SIFATransferEntity;
import com.mingcloud.proxy.logiclayer.beiqidisposeouthandler.webservice.DTFADisposeREQ;
import com.mingcloud.proxy.logiclayer.beiqidisposeouthandler.webservice.DTFADisposeRES;
import com.mingcloud.proxy.logiclayer.beiqidisposeouthandler.webservice.SIFADisposeOutEAM2SAPSYN;
import com.mingcloud.proxy.logiclayer.beiqidisposeouthandler.webservice.SIFADisposeOutEAM2SAPSYNService;
import org.apache.log4j.Logger;

import javax.xml.namespace.QName;
import javax.xml.ws.BindingProvider;
import java.text.SimpleDateFormat;
import java.util.Date;
import java.util.List;



/**
 * 固定资产处置流程输入线程
 * @author 张雨农
 * @date 2018-6-14
 */
public class BeiqiDisposeOutDataInThread implements Runnable {
	private static Logger logger = Logger.getLogger(BeiqiDisposeOutDataInThread.class);

	private static final QName SERVICE_NAME = new QName("http://eam.baicmotor.com",
			"SI_FADispose_Out_EAM2SAP_SYNService");

	private static SIFATransferData sIFATransferData = SIFATransferData.getInstance();

	private DataCenter dataCenter = DataCenter.getInstance();
	
	private SimpleDateFormat sdf = new SimpleDateFormat("yyyyMMdd");
	
	public void run() {
		while (true) {
			try {
				if (dataCenter.getWeatherCommonrecodeexlistSize() <= 100) {
					logger.info("BeiqiDataInThread running...");
					GetAllSIFATransferData();
					logger.info("BeiqiDataInThread wait for 5 minutes...");
					Thread.sleep(1* 60 * 1000);
				} else {
					logger.info("BeiqiDataInThread wait for 5 minutes...");
					Thread.sleep(1 * 60 * 1000);
				}
			} catch (InterruptedException e) {
				logger.error("BeiqiDataInThread: " + e);
			}
		}
	}

	private String checkInParameter(String parameter) {
		return parameter==null?"?":parameter;
	}

	private String checkOutParameter(String parameter) {
		return parameter=="<null>"?null:parameter;
	}
	
	public void GetAllSIFATransferData() {
		try {
			
			this.setStatusid();

			sIFATransferData.resetSIFATransferList();

			List<SIFATransferEntity> siList = sIFATransferData.getSIFATransferList();

			SIFADisposeOutEAM2SAPSYNService ss = new SIFADisposeOutEAM2SAPSYNService(SIFADisposeOutEAM2SAPSYNService.WSDL_LOCATION,
					SERVICE_NAME);

			SIFADisposeOutEAM2SAPSYN port = ss.getHTTPPort();
			System.out.println("Invoking siFADisposeOutEAM2SAPSYN...");

			((BindingProvider) port).getRequestContext().put(BindingProvider.USERNAME_PROPERTY, "SAP_MES_ZZ2");
			((BindingProvider) port).getRequestContext().put(BindingProvider.PASSWORD_PROPERTY, "Sap123456");

			DTFADisposeREQ _siFADisposeOutEAM2SAPSYN_mtFADisposeREQ = new DTFADisposeREQ();

			List<DTFADisposeREQ.FADisposeREQ> list = _siFADisposeOutEAM2SAPSYN_mtFADisposeREQ.getFADisposeREQ();

			for(SIFATransferEntity sientity : siList) {
				System.out.println(sientity);
				//测试用数据
				DTFADisposeREQ.FADisposeREQ entity = new DTFADisposeREQ.FADisposeREQ();
				entity.setANLABUKRS(checkInParameter(sientity.getExtravarchar20()));
				entity.setANLAANLN1(checkInParameter(sientity.getAssetkey()));
				entity.setSYDATUM(checkInParameter(sdf.format(new Date())));
				list.add(entity);
			}
			DTFADisposeRES siF_return = port.siFADisposeOutEAM2SAPSYN(_siFADisposeOutEAM2SAPSYN_mtFADisposeREQ);
			if(siF_return==null) {
				logger.info("BeiqiDataInThread:NoResultGet...");
				return;
			}
			List<DTFADisposeRES.FADisposeRES> li = siF_return.getFADisposeRES();
			for (DTFADisposeRES.FADisposeRES entit : li) {
				CommonrecodeexDto curdto = new CommonrecodeexDto();
				curdto.setExtravarchar1(checkOutParameter(entit.getANLABUKRS())); // 公司代码
				curdto.setExtravarchar2(checkOutParameter(entit.getANLAANLN1())); // 资产编号
				curdto.setExtravarchar3(checkOutParameter(entit.getSYDATUM())); // 资产报废日期
				curdto.setExtravarchar4(checkOutParameter(entit.getSYDATUM1())); // 更改日期
				curdto.setExtravarchar5(checkOutParameter(entit.getANEPANBTR()));//资产净值
				if(checkOutParameter(entit.getSYDATUM())==null && checkOutParameter(entit.getSYDATUM1())==null && checkOutParameter(entit.getANEPANBTR())==null) {
					logger.info("BeiqiDataInThread:UselessData");
					continue;
				}
				dataCenter.pushWeatherCommonrecodeexlist(curdto);
				logger.info("BeiqiDataInThread.GetDataSucceeded:"+dataCenter.getWeatherCommonrecodeexlist().toString());
			}
		} catch (Exception e) {
			logger.error("BeiqiDataInThread.GetAllPositionData(): " + e);
		}
	}
	
	private void setStatusid() {
		System.out.println("setStatusid>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>");
		sIFATransferData.setStatusid();
	}
	
}
